<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monolingual Text Checker</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <h1>Monolingual Text Checker</h1>
  <h3>Check a text for sensitive terms</h3>

  <br>

  <form class="container" id="textform">
    <div class="container" id="container">
      <div class="backdrop" id="backdrop">
        <div class="highlights">
          {{- marked_html | safe -}}
        </div>
      </div>
      <textarea id="textarea" name="user_text" placeholder="Add a text you would like to check for sensitive terms">{{ user_text }}</textarea>
      
    </div>
    <br>
    <div id="button_container">
      <div class="radio-buttons">
        <input type="radio" id="auto" name="language" value="auto" checked> <!-- Default to auto-detect -->
        <label id="detect_label" for="auto">Auto Detect Language</label>
        <input type="radio" id="english" name="language" value="english">
        <label for="english">English</label>
        <input type="radio" id="german" name="language" value="german">
        <label for="german">German</label>
      </div>
      <br>
      <button type="submit">Check</button>
      <button type="button" class="edit" id="edit_text">Edit text</button>
    </div>
  </form>
  <div class="mint-stripes"></div>
  <div class="purple-stripes"></div>
  <div id="modal_container">

  </div>

</body>

<script>
  var backdrop = document.getElementById("backdrop");
  var modal_container = document.getElementById("modal_container");

  // this function was taken from an answer on StackOverflow from user allenhwkim: https://stackoverflow.com/a/47614491
  function setInnerHTML(elm, html) {
    elm.innerHTML = html;
    
    Array.from(elm.querySelectorAll("script"))
        .forEach( oldScriptEl => {
        const newScriptEl = document.createElement("script");
        
        Array.from(oldScriptEl.attributes).forEach( attr => {
            newScriptEl.setAttribute(attr.name, attr.value) 
        });
        
        const scriptText = document.createTextNode(oldScriptEl.innerHTML);
        newScriptEl.appendChild(scriptText);
        
        oldScriptEl.parentNode.replaceChild(newScriptEl, oldScriptEl);
    });
  }

  var textarea = document.getElementById("textarea");
  var edit_button= document.getElementById("edit_text");
  edit_button.addEventListener("click", (event) =>{
    textarea.style.pointerEvents = "all";
    backdrop.style.visibility = "invisible";
    textarea2.style.color = "black";
  });

  textarea.addEventListener("scroll",(event) => {
    var scrollTop = textarea.scrollTop;
    backdrop.scrollTop = scrollTop;
  });
  backdrop.addEventListener("scroll",(event) => {
    var scrollTop = backdrop.scrollTop;
    textarea.scrollTop = scrollTop;
  });

  async function mark_offensive(term_id) {
    const data = new URLSearchParams();
    data.append("term_id", term_id);

    fetch("{{ url_for('report') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: data,
        
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(data => {
      sendData();
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });

  }

  async function rateAlternative(term_id, alt_id, rating) {
    const data = new URLSearchParams();
    data.append("original_id", term_id);
    data.append("alternative_id", alt_id);
    data.append("rating", rating);

    fetch("{{ url_for('rate_alternative') }}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: data,
        
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(data => {
      // check again to update popups
      sendData();
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });

  }

  function showPopup(t){
    t.target.childNodes[1].style.visibility = "visible";
  }

  function hidePopup(t){
    t.target.childNodes[1].style.visibility = "hidden";
  }
  
  var modals = "";
  var container = document.getElementById("container");
  const form = document.querySelector("#textform");
  var auto_detect_label = document.getElementById("detect_label");
  async function sendData() {
    // Associate the FormData object with the form element
    const formData = new FormData(form);

    fetch("{{ url_for('submit') }}", {
        method: 'POST',
        body: formData,
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        setInnerHTML(container, data.textarea);

        if(data.detected == 1){
          var lang = data.language;
          auto_detect_label.textContent = lang + " - Detected"
        }

        // attach new event listeners
        backdrop = document.getElementById("backdrop");
        var textarea2 = document.getElementById("textarea");
        textarea2.addEventListener("scroll",(event) => {
          var scrollTop = textarea2.scrollTop;
          backdrop.scrollTop = scrollTop;
        });
        backdrop.addEventListener("scroll",(event) => {
          var scrollTop = backdrop.scrollTop;
          textarea2.scrollTop = scrollTop;
        });
        edit_button.addEventListener("click", (event) =>{
          textarea2.style.pointerEvents = "all";
          textarea2.style.color = "black";
          backdrop.style.visibility = "hidden";
          backdrop.style.zIndex = "1";
        });

        const openEls = document.querySelectorAll("[data-open]");

        const isVisible = "is-visible";
        setInnerHTML(modal_container, data.modals);

        for(const el of openEls) {
          el.addEventListener("click", function() {
            const modalId = this.dataset.open;
            document.getElementById(modalId).classList.add(isVisible);
          });
        }

        const rateEls = document.querySelectorAll("[rate-alternative]");
        for(const el of rateEls) {
          el.addEventListener("click", function() {
            const modalId = this.dataset.open;
            // get the rating
            var f_id = 'rate'+modalId
            var fieldset = document.getElementById(f_id);
            var selectedRadioButton = fieldset.querySelector('input[name="alternative_rating"]:checked');
            var rating = 3;
            if (selectedRadioButton) {
              rating = selectedRadioButton.value;
            }
            // call rating function
            rateAlternative(this.getAttribute("term_id"), this.getAttribute("alt_id"), rating);
          });
        }

        const closeEls = document.querySelectorAll("[data-close]");
        for (const el of closeEls) {
          el.addEventListener("click", function() {
            this.parentElement.parentElement.parentElement.classList.remove(isVisible);
          });
        }

        document.addEventListener("click", e => {
          if (e.target == document.querySelector(".modal.is-visible")) {
            document.querySelector(".modal.is-visible").classList.remove(isVisible);
          }
        });
        var marks = document.querySelectorAll('.popup');
        for (var i = 0; i < marks.length; i++) {
          marks[i].addEventListener("mouseenter", showPopup, marks[i]);
          marks[i].addEventListener("mouseleave", hidePopup, marks[i]);
        }     
        textarea2.style.pointerEvents = "none";
        textarea2.style.color = "transparent";
        backdrop.style.visibility = "visible";
        backdrop.style.zIndex = "2";

    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });

  }

  const openEls = document.querySelectorAll("[data-open]");
  const isVisible = "is-visible";

  for(const el of openEls) {
    el.addEventListener("click", function() {
      const modalId = this.dataset.open;
      document.getElementById(modalId).classList.add(isVisible);
    });
  }

  const closeEls = document.querySelectorAll("[data-close]");
  for (const el of closeEls) {
    el.addEventListener("click", function() {
      this.parentElement.parentElement.parentElement.classList.remove(isVisible);
    });
  }

  document.addEventListener("click", e => {
    if (e.target == document.querySelector(".modal.is-visible")) {
      document.querySelector(".modal.is-visible").classList.remove(isVisible);
    }
  });

  var marks = document.querySelectorAll('.popup');
  for (var i = 0; i < marks.length; i++) {
    marks[i].addEventListener("mouseenter", showPopup, marks[i]);
    marks[i].addEventListener("mouseleave", hidePopup, marks[i]);
  }   

  // Take over form submission
  form.addEventListener("submit", (event) => {
    event.preventDefault();
    sendData();
  });
  </script>
</html>